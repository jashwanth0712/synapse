<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Freighter API Test</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #1a1a2e;
      color: white;
    }
    h1 { color: #7c3aed; }
    .test-result {
      padding: 16px;
      margin: 12px 0;
      border-radius: 8px;
      background: rgba(255,255,255,0.1);
    }
    .success { border-left: 4px solid #10b981; }
    .error { border-left: 4px solid #ef4444; }
    .info { border-left: 4px solid #3b82f6; }
    button {
      padding: 12px 24px;
      font-size: 16px;
      background: #7c3aed;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 8px 8px 8px 0;
    }
    button:hover { background: #6d28d9; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    pre {
      background: #0f0f1a;
      padding: 16px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 14px;
    }
    #log {
      max-height: 400px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <h1>üîç Freighter API Detection Test</h1>
  
  <p>This page tests different methods to detect and connect to the Freighter wallet extension.</p>

  <div id="results"></div>

  <h2>Actions</h2>
  <button id="checkWindowFreighter">Check window.freighter</button>
  <button id="checkWindowFreighterApi">Check window.freighterApi</button>
  <button id="listWindowProps">List Freighter-related window props</button>
  <button id="tryConnect">Try Connect</button>
  <button id="tryCDN">Try CDN Import</button>
  <button id="clearLog">Clear Log</button>

  <h2>Log</h2>
  <pre id="log"></pre>

  <script>
    const resultsEl = document.getElementById('results');
    const logEl = document.getElementById('log');

    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      logEl.textContent += `[${timestamp}] ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(message);
    }

    function addResult(title, content, type = 'info') {
      const div = document.createElement('div');
      div.className = `test-result ${type}`;
      div.innerHTML = `<strong>${title}</strong><br>${content}`;
      resultsEl.appendChild(div);
    }

    function clearResults() {
      resultsEl.innerHTML = '';
      logEl.textContent = '';
    }

    // Initial checks on page load
    window.addEventListener('load', async () => {
      log('Page loaded, running initial checks...');
      
      // Check immediately
      checkAllMethods();
      
      // Check after a delay (extensions might inject later)
      setTimeout(() => {
        log('\n--- Checking again after 2 seconds ---');
        checkAllMethods();
      }, 2000);
    });

    function checkAllMethods() {
      // Method 1: window.freighter
      log(`window.freighter: ${typeof window.freighter}`);
      if (window.freighter) {
        log(`  Keys: ${Object.keys(window.freighter).join(', ')}`);
      }

      // Method 2: window.freighterApi
      log(`window.freighterApi: ${typeof window.freighterApi}`);
      if (window.freighterApi) {
        log(`  Keys: ${Object.keys(window.freighterApi).join(', ')}`);
      }

      // Method 3: Check for extension-injected elements
      const scripts = document.querySelectorAll('script');
      let freighterScripts = [];
      scripts.forEach(s => {
        if (s.src && s.src.toLowerCase().includes('freighter')) {
          freighterScripts.push(s.src);
        }
      });
      log(`Freighter-related scripts: ${freighterScripts.length > 0 ? freighterScripts.join(', ') : 'none'}`);

      // Check all window properties containing 'freighter'
      const freighterProps = Object.keys(window).filter(k => 
        k.toLowerCase().includes('freighter') || k.toLowerCase().includes('stellar')
      );
      log(`Window props with freighter/stellar: ${freighterProps.length > 0 ? freighterProps.join(', ') : 'none'}`);
    }

    // Button handlers
    document.getElementById('checkWindowFreighter').addEventListener('click', () => {
      log('\n--- Checking window.freighter ---');
      if (typeof window.freighter !== 'undefined') {
        addResult('window.freighter', `Available! Type: ${typeof window.freighter}<br>Keys: ${Object.keys(window.freighter).join(', ')}`, 'success');
        log('window.freighter is available');
        log(`Type: ${typeof window.freighter}`);
        log(`Keys: ${Object.keys(window.freighter).join(', ')}`);
      } else {
        addResult('window.freighter', 'Not found', 'error');
        log('window.freighter is undefined');
      }
    });

    document.getElementById('checkWindowFreighterApi').addEventListener('click', () => {
      log('\n--- Checking window.freighterApi ---');
      if (typeof window.freighterApi !== 'undefined') {
        addResult('window.freighterApi', `Available! Type: ${typeof window.freighterApi}<br>Keys: ${Object.keys(window.freighterApi).join(', ')}`, 'success');
        log('window.freighterApi is available');
        log(`Type: ${typeof window.freighterApi}`);
        log(`Keys: ${Object.keys(window.freighterApi).join(', ')}`);
      } else {
        addResult('window.freighterApi', 'Not found', 'error');
        log('window.freighterApi is undefined');
      }
    });

    document.getElementById('listWindowProps').addEventListener('click', () => {
      log('\n--- Listing Freighter-related window properties ---');
      const props = Object.keys(window).filter(k => 
        k.toLowerCase().includes('freighter') || 
        k.toLowerCase().includes('stellar') ||
        k.toLowerCase().includes('wallet')
      );
      if (props.length > 0) {
        addResult('Freighter-related window props', props.map(p => `${p}: ${typeof window[p]}`).join('<br>'), 'success');
        props.forEach(p => log(`  ${p}: ${typeof window[p]}`));
      } else {
        addResult('Freighter-related window props', 'None found', 'error');
        log('No freighter/stellar/wallet related window properties found');
      }
    });

    document.getElementById('tryConnect').addEventListener('click', async () => {
      log('\n--- Trying to connect ---');
      
      // Try window.freighterApi first
      if (window.freighterApi) {
        try {
          log('Using window.freighterApi...');
          
          // Check isConnected
          if (typeof window.freighterApi.isConnected === 'function') {
            const connResult = await window.freighterApi.isConnected();
            log(`isConnected result: ${JSON.stringify(connResult)}`);
          }
          
          // Request access
          if (typeof window.freighterApi.requestAccess === 'function') {
            log('Calling requestAccess...');
            const accessResult = await window.freighterApi.requestAccess();
            log(`requestAccess result: ${JSON.stringify(accessResult)}`);
            addResult('requestAccess', JSON.stringify(accessResult, null, 2), accessResult.error ? 'error' : 'success');
          }
          
          // Get address
          if (typeof window.freighterApi.getAddress === 'function') {
            log('Calling getAddress...');
            const addrResult = await window.freighterApi.getAddress();
            log(`getAddress result: ${JSON.stringify(addrResult)}`);
            addResult('getAddress', JSON.stringify(addrResult, null, 2), addrResult.error ? 'error' : 'success');
          }
        } catch (e) {
          log(`Error: ${e.message}`);
          addResult('Connection Error', e.message, 'error');
        }
      } 
      // Try window.freighter
      else if (window.freighter) {
        try {
          log('Using window.freighter...');
          
          if (typeof window.freighter.isConnected === 'function') {
            const connResult = await window.freighter.isConnected();
            log(`isConnected result: ${JSON.stringify(connResult)}`);
          }
          
          if (typeof window.freighter.requestAccess === 'function') {
            log('Calling requestAccess...');
            const accessResult = await window.freighter.requestAccess();
            log(`requestAccess result: ${JSON.stringify(accessResult)}`);
            addResult('requestAccess', JSON.stringify(accessResult, null, 2), 'success');
          }
          
          if (typeof window.freighter.getAddress === 'function') {
            log('Calling getAddress...');
            const addrResult = await window.freighter.getAddress();
            log(`getAddress result: ${JSON.stringify(addrResult)}`);
            addResult('getAddress', JSON.stringify(addrResult, null, 2), 'success');
          }
        } catch (e) {
          log(`Error: ${e.message}`);
          addResult('Connection Error', e.message, 'error');
        }
      } else {
        log('Neither window.freighterApi nor window.freighter available');
        addResult('No Freighter API', 'Neither window.freighterApi nor window.freighter is available. Is Freighter installed?', 'error');
      }
    });

    document.getElementById('tryCDN').addEventListener('click', async () => {
      log('\n--- Trying CDN import ---');
      try {
        log('Importing from CDN...');
        const module = await import('https://cdn.jsdelivr.net/npm/@stellar/freighter-api@6.0.0/+esm');
        log(`Module keys: ${Object.keys(module).join(', ')}`);
        
        // Check module.default
        if (module.default) {
          log(`module.default type: ${typeof module.default}`);
          if (typeof module.default === 'object') {
            log(`module.default keys: ${Object.keys(module.default).join(', ')}`);
            ['isConnected', 'requestAccess', 'getAddress', 'signTransaction', 'getNetwork'].forEach(fn => {
              log(`  module.default.${fn}: ${typeof module.default[fn]}`);
            });
          }
        }
        
        // Check direct exports
        ['isConnected', 'requestAccess', 'getAddress', 'signTransaction', 'getNetwork'].forEach(fn => {
          log(`  module.${fn}: ${typeof module[fn]}`);
        });
        
        // Try to find the actual API object
        let api = null;
        if (module.default && typeof module.default === 'object') {
          if (module.default.isConnected || module.default.getAddress) {
            api = module.default;
            log('Using module.default as API');
          }
        } else if (module.isConnected || module.getAddress) {
          api = module;
          log('Using module directly as API');
        }
        
        if (api) {
          addResult('CDN Import', `API found! Keys: ${Object.keys(api).filter(k => typeof api[k] === 'function').join(', ')}`, 'success');
          
          // Try isConnected
          if (typeof api.isConnected === 'function') {
            log('Calling api.isConnected()...');
            const result = await api.isConnected();
            log(`isConnected result: ${JSON.stringify(result)}`);
            addResult('CDN isConnected', JSON.stringify(result, null, 2), result.isConnected ? 'success' : 'info');
          }
          
          // Try requestAccess
          if (typeof api.requestAccess === 'function') {
            log('Calling api.requestAccess()...');
            const result = await api.requestAccess();
            log(`requestAccess result: ${JSON.stringify(result)}`);
            addResult('CDN requestAccess', JSON.stringify(result, null, 2), result.error ? 'error' : 'success');
          }
          
          // Try getAddress
          if (typeof api.getAddress === 'function') {
            log('Calling api.getAddress()...');
            const result = await api.getAddress();
            log(`getAddress result: ${JSON.stringify(result)}`);
            addResult('CDN getAddress', JSON.stringify(result, null, 2), result.error ? 'error' : 'success');
          }
        } else {
          addResult('CDN Import', `Module loaded but API not found. Module structure: ${JSON.stringify(Object.keys(module))}`, 'error');
        }
        
      } catch (e) {
        log(`CDN import error: ${e.message}`);
        log(`Error stack: ${e.stack}`);
        addResult('CDN Import Error', e.message, 'error');
      }
    });

    document.getElementById('clearLog').addEventListener('click', clearResults);
  </script>
</body>
</html>

